<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
  
  </head>
 
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
<body>
  <div id="message-container"></div>
  <br>
  <br>
  <br>
  <label>Upload File: <input type="file" id="upload-id" accept="image/*"/></label>
  <button id="imageButton" onclick="imageUpload()"
   class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored">
    <i class="material-icons">add</i>
  </button>

  <form id='form-container'>
    <form action="#">
      <div class="mdl-textfield mdl-js-textfield">
        <input class="mdl-textfield__input" type="text" id="message">
        <label class="mdl-textfield__label" for="message">Text...</label>
      </div>
    </form>
    
    <button id='sendButton' type='submit'>Send</button>
  </form>

  <script src="/socket.io/socket.io.js"></script>
 
  <script>

  const socket = io();
  var imgChunks = [];
const messageContainer = document.getElementById('message-container');
const messageForm = document.getElementById('form-container');
const message = document.getElementById('message');
const name = prompt('Whats your sweet name?');
  appendMessage(`You joined`);
  console.log('name-joined---', name);
  socket.emit('new-user', name);
  
socket.on('chat-from-server', (chat) => {
    console.log('received msg', chat);
    appendMessage(`${chat.name} : ${chat.chat}`);
});
socket.on('user-connected', (user) => {
    console.log('received user name', user);
    appendMessage(`${user} joined our chat`);
});
socket.on('user-disconnected', (user) => {
    console.log('received user name', user);
    appendMessage(`${user} left our chat`);
});
socket.on('img-chunk', (chunk) => {
  
  var imgtag = document.createElement('img');

  for (let key in chunk) {
    console.log('key', key);
    // console.log('key chunk', chunk[key]);
    imgChunks.push(chunk[key]);
  }
  console.log('imgChunks', imgChunks)
  imgtag.setAttribute('src', 'data:image/jpeg;base64,' + window.btoa(imgChunks));
  imgChunks=[];
  chunks=[];
  console.log('chunks cleared', imgChunks);
  messageContainer.append(imgtag);
});
messageForm.addEventListener('submit', e => {
  message1 = message.value
  console.log('message---', message1);
    e.preventDefault();
    appendMessage(`You:${message1}`);
    socket.emit('chat-from-client', message1);
    message.value='';
});

function appendMessage (message) {
    const messageElement = document.createElement('div');
    messageElement.innerText = message;
    messageContainer.append(messageElement);
};
function imageUpload () {
  console.log('uploadimage called');
  let photo = document.getElementById("upload-id").files[0];
  let formData = new FormData();
  console.log('photoname', photo.name);
  formData.append("photo", photo);

  socket.emit('image-upload-from-client', {photo:photo, imgName:photo.name});
 
  console.log('photo', photo);
  console.log('name', photo.name);
}
  </script>
</body>

</html>